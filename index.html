<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Điểm Danh & Đăng Ký - HVCTKV II</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #334155; /* Slate-700 */
            --primary-dark-color: #1e293b; /* Slate-800 */
            --secondary-color: #0d9488; /* Teal-600 */
            --secondary-dark-color: #0f766e; /* Teal-700 */
            --summary-header-bg: #3b5998; /* Facebook Blue */
            --pending-color: #f59e0b; /* Amber-500 */
            --approved-color: #16a34a; /* Green-600 */
            --rejected-color: #dc2626; /* Red-600 */
        }
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .content-card { background-color: rgba(255, 255, 255, 0.98); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); border: 1px solid #e2e8f0; }
        .table-container { max-width: 100%; overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; max-height: 50vh; overflow-y: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e2e8f0; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.875rem; white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .table-container thead th { position: sticky; top: 0; z-index: 10; }
        .form-select, .form-input { border-radius: 0.5rem; border: 1px solid #cbd5e1; padding: 0.6rem 0.8rem; width: 100%; background-color: #f8fafc; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(51, 65, 85, 0.4); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.5rem; padding: 0.625rem 1.25rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark-color); }
        .btn-secondary { background-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-dark-color); }
        #loadingOverlay { transition: opacity 0.3s; }
        #summaryTable > thead > tr > th { background-color: var(--summary-header-bg); color: white; }
        #summaryTable th:nth-child(1), #summaryTable td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 2;
            width: 60px;
            min-width: 60px;
        }
        #summaryTable th:nth-child(2), #summaryTable td:nth-child(2) {
            position: sticky;
            left: 60px; /* Match width of first column */
            z-index: 2;
            min-width: 120px;
            font-weight: 600;
        }
        #summaryTable td:nth-child(1), #summaryTable td:nth-child(2) { background-color: #f1f5f9; }
        #summaryTable th:nth-child(1), #summaryTable th:nth-child(2) { z-index: 11; }
        #summaryTable td:nth-child(2) { border-right: 2px solid #9ca3af; }
        .clickable-cell { cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .clickable-cell:hover { background-color: #f1f5f9; }
        .important-column { color: #111827; font-weight: 500; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .modal-scale { transform: translate(0, -25%) scale(0.95); opacity: 0; }
        .modal-active { transform: translate(0, 0) scale(1); opacity: 1; }
        .today-absence-highlight { background-color: #facc15 !important; color: #1e293b !important; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; color: white; }
        .status-pending { background-color: var(--pending-color); }
        .status-approved { background-color: var(--approved-color); }
        .status-rejected { background-color: var(--rejected-color); }
        .k75-header { background-color: #475569 !important; }
        .k75-cell { background-color: #f1f5f9; }
        .clickable-cell.k75-cell:hover { background-color: #e2e8f0; }
        .btn-approve { background-color: var(--approved-color); color: white; }
        .btn-approve:hover { background-color: #15803d; }
        .btn-reject { background-color: var(--pending-color); color: white; }
        .btn-reject:hover { background-color: #d97706; }

        /* New Menu Styles */
        .menu-item {
            transition: background-color 0.2s, color 0.2s;
        }
        .menu-item.active, .menu-item:hover {
            background-color: rgba(255,255,255,0.15);
            color: white;
        }
         .menu-item.active i, .menu-item:hover i {
            color: #facc15; /* yellow-400 */
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
             <div class="w-16 h-16 border-4 border-slate-700 border-t-transparent rounded-full animate-spin"></div>
             <p class="mt-4 text-gray-700 font-semibold">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="flex h-screen bg-white">
        <!-- Sidebar Menu -->
        <nav id="sidebar-menu" class="w-64 text-slate-100 flex flex-col" style="background: linear-gradient(rgba(40, 0, 0, 0.8), rgba(40, 0, 0, 0.8)), url('Hình nền Biểu tượng Búa - Liềm Đảng Cộng Sản Việt Nam - Tuyệt Kỹ Powerpoint.jfif'); background-size: cover; background-position: center;">
            <div class="p-4 border-b border-white/20 flex items-center gap-3">
                <img src="LOGO HV2.png" alt="Logo" class="h-10 w-10">
                <h1 class="text-sm font-bold text-white tracking-wider">Quản lý học viên</h1>
            </div>
            <ul class="flex-1 p-2 space-y-1">
                <li><button data-page="page-tong-quan" class="menu-item active w-full flex items-center gap-3 p-3 rounded-md text-sm font-semibold"><i class="fas fa-chart-pie w-5 text-center text-yellow-500"></i>Tổng quan</button></li>
                <li><button data-page="page-diem-danh" class="menu-item w-full flex items-center gap-3 p-3 rounded-md text-sm font-semibold"><i class="fas fa-calendar-check w-5 text-center text-yellow-500"></i>Điểm danh</button></li>
                <li><button data-page="page-hoc-bo-sung" class="menu-item w-full flex items-center gap-3 p-3 rounded-md text-sm font-semibold"><i class="fas fa-book-reader w-5 text-center text-yellow-500"></i>Học bổ sung</button></li>
                <li><button data-page="page-lich-thi" class="menu-item w-full flex items-center gap-3 p-3 rounded-md text-sm font-semibold"><i class="fas fa-graduation-cap w-5 text-center text-yellow-500"></i>Lịch thi</button></li>
                <li><button data-page="page-bao-luu" class="menu-item w-full flex items-center gap-3 p-3 rounded-md text-sm font-semibold"><i class="fas fa-user-clock w-5 text-center text-yellow-500"></i>Bảo lưu</button></li>
            </ul>
            <div class="p-3 mt-auto border-t border-white/20 text-center text-xs text-slate-300">
                <p class="font-semibold">Phát triển bởi: Dungcdr</p>
                <p>Email: nguyendungvtlt@gmail.com</p>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
             <header class="bg-white border-b px-6 py-3 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-6">
                        <img src="CODANG, CO TO QUOC.gif" alt="Cờ Đảng, Cờ Tổ Quốc" class="h-16 hidden md:block">
                        <h2 id="page-title" class="text-2xl font-bold text-slate-800">Tổng quan</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <h1 class="text-xl lg:text-2xl font-bold uppercase text-red-800">Học viện Chính trị khu vực II</h1>
                            <p class="text-sm text-slate-600 font-semibold">Ban Quản lý đào tạo, bồi dưỡng</p>
                        </div>
                        <img src="LOGO HV2.png" alt="Logo Học viện" class="h-16 w-16">
                    </div>
                </div>
            </header>

             <main class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 bg-slate-50">
                <!-- Page: Tổng Quan -->
                <section id="page-tong-quan" class="content-page space-y-6">
                    <div class="content-card">
                         <div class="card-header"><h3 class="text-xl font-bold text-gray-800">Bảng thống kê điểm danh</h3></div>
                         <div class="p-4">
                            <div class="table-container">
                                <table id="summaryTable"><thead><tr><th>STT</th><th>Tên môn học</th></tr></thead><tbody></tbody></table>
                            </div>
                         </div>
                    </div>
                </section>

                <!-- Page: Điểm Danh -->
                <section id="page-diem-danh" class="content-page hidden space-y-6">
                    <div class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-slate-700">CNL/Cán bộ Ban QLĐTBD nhập thông tin điểm danh</h3></div>
                        <form id="absenceForm" class="p-6 space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label><input type="text" id="studentName" class="form-input" placeholder="Nguyễn Văn A" required></div>
                                <div><label for="studentClass" class="block text-sm font-medium text-gray-700 mb-1">Tên lớp</label><select id="studentClass" class="form-select" required></select></div>
                                <div><label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Tên môn học</label><select id="subject" class="form-select" required></select></div>
                                <div><label for="absenceDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày vắng</label><input type="date" id="absenceDate" class="form-input" required></div>
                                <div><label for="session" class="block text-sm font-medium text-gray-700 mb-1">Buổi</label><select id="session" class="form-select" required><option value="Sáng">Sáng</option><option value="Chiều">Chiều</option></select></div>
                                <div><label for="permission" class="block text-sm font-medium text-gray-700 mb-1">Lý do</label><select id="permission" class="form-select" required><option value="Không phép">Không phép</option><option value="Có phép">Có phép</option></select></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full sm:w-auto"><i class="fa-solid fa-plus"></i>Thêm lượt vắng</button>
                        </form>
                    </div>
                    <div class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-orange-600">Duyệt đơn xin nghỉ phép</h3></div>
                        <div class="p-4">
                            <div class="table-container">
                                <table class="w-full">
                                    <thead style="background-color: var(--pending-color);"><tr><th>Họ và tên</th><th>Lớp</th><th>Môn học</th><th>Ngày vắng</th><th>Buổi</th><th>Thao tác</th></tr></thead>
                                    <tbody id="pendingAbsenceLog" class="bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="card-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="text-xl font-bold text-slate-700">Lịch sử điểm danh</h3>
                            <input type="text" id="searchInput" placeholder="Tìm kiếm trong lịch sử..." class="form-input w-full sm:w-64">
                        </div>
                        <div class="p-4">
                            <div class="table-container">
                                <table class="w-full">
                                    <thead style="background-color: var(--summary-header-bg);"><tr><th>Họ và tên</th><th>Tên lớp</th><th>Môn học</th><th>Ngày vắng</th><th>Buổi</th><th>Lý do</th><th>Trạng thái</th><th>Thao tác</th></tr></thead>
                                    <tbody id="absenceLog" class="bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Page: Học Bổ Sung -->
                <section id="page-hoc-bo-sung" class="content-page hidden space-y-6">
                     <div class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-teal-600">Đăng ký học bổ sung</h3></div>
                         <form id="registrationForm" class="p-6 space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="regStudentName" class="block text-sm font-medium text-gray-700 mb-1">Họ tên học viên</label><input type="text" id="regStudentName" class="form-input" placeholder="Nguyễn Văn A" required></div>
                                <div><label for="regStudentClass" class="block text-sm font-medium text-gray-700 mb-1">Lớp</label><select id="regStudentClass" class="form-select" required></select></div>
                                <div class="sm:col-span-2"><label for="regChuNhiem" class="block text-sm font-medium text-gray-700 mb-1">Chủ nhiệm lớp</label><input type="text" id="regChuNhiem" class="form-input" placeholder="Trần Thị B" required></div>
                                <div><label for="regSubject" class="block text-sm font-medium text-gray-700 mb-1">Môn học cần bổ sung</label><select id="regSubject" class="form-select" required></select></div>
                                <div>
                                    <label for="regChuyenDe" class="block text-sm font-medium text-gray-700 mb-1">Tên chuyên đề</label>
                                    <input type="text" id="regChuyenDe" class="form-input" placeholder="Nhập tên chuyên đề" required>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thời gian học (Tối đa 4 buổi)</label>
                                    <div id="thoiGianHocContainer" class="space-y-2"></div>
                                    <button type="button" id="addSessionBtn" class="mt-2 text-sm btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-3 py-1"><i class="fa-solid fa-plus mr-1"></i>Thêm buổi</button>
                                </div>
                                <div class="sm:col-span-2"><label for="regHocCungLop" class="block text-sm font-medium text-gray-700 mb-1">Học bổ sung cùng với lớp</label><select id="regHocCungLop" class="form-select" required></select></div>
                            </div>
                            <button type="submit" class="btn btn-secondary w-full sm:w-auto"><i class="fa-solid fa-check"></i>Đăng ký</button>
                        </form>
                    </div>
                     <div class="content-card">
                        <div class="card-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="text-xl font-bold text-teal-600">Danh sách đã đăng ký học bổ sung</h3>
                            <div class="flex items-center gap-4">
                                <input type="text" id="registrationSearchInput" placeholder="Tìm kiếm..." class="form-input w-full sm:w-64">
                                <button id="exportExcelBtn" class="btn bg-green-600 hover:bg-green-700 text-white flex-shrink-0"><i class="fa-solid fa-file-excel mr-2"></i>Xuất Excel</button>
                            </div>
                        </div>
                        <div class="p-4">
                             <div class="table-container">
                                <table class="w-full">
                                    <thead style="background-color: var(--summary-header-bg);"><tr><th>STT</th><th>Họ tên HV</th><th>Tên lớp</th><th>Chủ nhiệm</th><th>Môn học</th><th>Chuyên đề</th><th>Thời gian học</th><th>Học cùng lớp</th><th>Trạng thái</th><th>Thao tác</th></tr></thead>
                                    <tbody id="registrationLog" class="bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Page: Lịch Thi -->
                <section id="page-lich-thi" class="content-page hidden space-y-6">
                    <div class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-indigo-800">Quản lý & Tra cứu Lịch thi</h3></div>
                        <div class="p-6 space-y-6">
                            <div class="p-4 border rounded-lg bg-gray-50 space-y-3">
                                <h4 class="text-lg font-semibold text-gray-800">Upload Lịch thi từ File Excel</h4>
                                <div>
                                    <label for="examFileUpload" class="block text-sm font-medium text-gray-700 mb-1">Chọn file Excel (.xlsx)</label>
                                    <input type="file" id="examFileUpload" class="form-input" accept=".xlsx, .xls">
                                </div>
                                <p class="text-xs text-gray-500"><i class="fa-solid fa-info-circle mr-1"></i>File Excel phải có 4 cột: <strong>Lop</strong>, <strong>MonHoc</strong>, <strong>NgayThi</strong>, <strong>Buoi</strong>.</p>
                                <button id="importExamBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white"><i class="fa-solid fa-upload mr-2"></i>Tải lên & nhập dữ liệu</button>
                            </div>
                            <div>
                                 <div class="flex flex-col md:flex-row gap-4 mb-4">
                                    <div class="flex-1">
                                        <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo lớp</label>
                                        <select id="filterClass" class="form-select"></select>
                                    </div>
                                    <div class="flex-1">
                                        <label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo môn</label>
                                        <select id="filterSubject" class="form-select"></select>
                                    </div>
                                </div>
                                 <div class="table-container max-h-72">
                                    <table class="w-full">
                                        <thead style="background-color: var(--summary-header-bg);"><tr><th>Lớp</th><th>Môn học</th><th>Ngày thi</th><th>Buổi</th><th>Thao tác</th></tr></thead>
                                        <tbody id="examLookupTableBody" class="bg-white"></tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Page: Bảo Lưu -->
                <section id="page-bao-luu" class="content-page hidden space-y-6">
                    <div class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-blue-800">Quản lý Bảo lưu Kết quả học tập</h3></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-6">
                            <div class="lg:col-span-1">
                                 <form id="leaveForm" class="space-y-4">
                                    <h4 class="text-lg font-semibold text-gray-800">Thêm học viên bảo lưu</h4>
                                    <div><label for="leaveStudentName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label><input type="text" id="leaveStudentName" class="form-input" required></div>
                                    <div><label for="leaveStudentClass" class="block text-sm font-medium text-gray-700 mb-1">Lớp</label><select id="leaveStudentClass" class="form-select" required></select></div>
                                    <div><label for="leaveStartDate" class="block text-sm font-medium text-gray-700 mb-1">Bảo lưu bắt đầu từ ngày</label><input type="date" id="leaveStartDate" class="form-input" required></div>
                                    <div><label for="leaveReason" class="block text-sm font-medium text-gray-700 mb-1">Lý do</label><textarea id="leaveReason" class="form-input" rows="3" placeholder="Quyết định số..."></textarea></div>
                                    <p class="text-xs text-gray-500"><i class="fa-solid fa-info-circle mr-1"></i>Thời hạn bảo lưu tối đa là 3 năm.</p>
                                    <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full"><i class="fa-solid fa-save mr-2"></i>Lưu thông tin</button>
                                </form>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="flex justify-between items-center mb-4">
                                     <h4 class="text-lg font-semibold text-gray-800">Danh sách học viên bảo lưu</h4>
                                     <input type="text" id="leaveSearchInput" placeholder="Tìm kiếm..." class="form-input w-full sm:w-64">
                                 </div>
                                 <div class="table-container">
                                    <table class="w-full">
                                        <thead style="background-color: var(--summary-header-bg);"><tr><th>STT</th><th>Họ tên HV</th><th>Lớp</th><th>Bảo lưu từ ngày</th><th>Lý do</th><th>Thao tác</th></tr></thead>
                                        <tbody id="leaveLog" class="bg-white"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
             </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[60]"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transition-all duration-300 modal-scale"><div class="p-4 border-b flex justify-between items-center"><h3 id="modalTitle" class="text-lg font-bold text-gray-800"></h3><button id="closeModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div><div id="modalBody" class="p-6 max-h-[60vh] overflow-y-auto"></div></div></div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[60]"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm transition-all duration-300 modal-scale"><div class="p-6 text-center"><h3 class="text-lg font-bold text-gray-800 mb-2">Xác nhận hành động</h3><p id="confirmMessage" class="text-sm text-gray-600 mb-6"></p><div class="flex justify-center gap-4"><button id="confirmCancel" class="btn bg-gray-500 hover:bg-gray-600 text-white">Hủy</button><button id="confirmOk" class="btn bg-red-600 hover:bg-red-700 text-white">Đồng ý</button></div></div></div></div>
    <div id="notification" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transition-all duration-300 z-[70]"><p id="notificationMessage"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, setDoc, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAdwypOgoxMcrA2JxsfKD2vUqbnLfUuqzA", authDomain: "diem-danh-hoc-vien.firebaseapp.com", projectId: "diem-danh-hoc-vien", storageBucket: "diem-danh-hoc-vien.firebasestorage.app", messagingSenderId: "186541306115", appId: "1:186541306115:web:89424d662913ec9f9a3936", measurementId: "G-2T5MQRG9JQ" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        function showAuthError() {
            const loadingText = document.querySelector("#loadingOverlay p");
            if (loadingText) loadingText.textContent = "Lỗi xác thực. Vui lòng kiểm tra lại quy tắc bảo mật của Firebase.";
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function initializeAppLogic() {
            // Firestore collections
            const absenceCollection = collection(db, 'diem-danh');
            const registrationCollection = collection(db, 'dang-ky-hoc-bo-sung');
            const examScheduleCollection = collection(db, 'lich-thi');
            const leaveCollection = collection(db, 'bao-luu-hoc-tap');

            // Data
            const subjects = ["Tuần lễ học viên", "TRIET", "KTCT", "CNXH", "TTHCM", "LSĐ", "QLKT", "NNPL", "KTPT", "QHQT", "VHPT", "GDQP", "TGTN", "LLDT", "GIOI", "QCN", "KHLĐ", "XHH", "CTH", "XDĐ", "NgK"];
            const classes = [ ...Array.from({ length: 12 }, (_, i) => `K76.A${(i + 1).toString().padStart(2, '0')}`), 'K75.B06', 'K75.B07', 'K75.B08', 'K75.B09', 'K75.B10' ];
            let localAbsenceData = [], localRegistrationData = [], localExamData = [], localLeaveData = [];
            
            // Element Refs
            const loadingOverlay = document.getElementById('loadingOverlay');
            const pageTitle = document.getElementById('page-title');
            const summaryTableBody = document.getElementById('summaryTable').querySelector('tbody');
            const studentClassSelect = document.getElementById('studentClass'), subjectSelect = document.getElementById('subject');
            const absenceForm = document.getElementById('absenceForm'), absenceLog = document.getElementById('absenceLog');
            const searchInput = document.getElementById('searchInput');
            const detailsModal = document.getElementById('detailsModal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), closeModal = document.getElementById('closeModal');
            const confirmModal = document.getElementById('confirmModal'), confirmMessage = document.getElementById('confirmMessage'), confirmCancel = document.getElementById('confirmCancel'), confirmOk = document.getElementById('confirmOk');
            const notification = document.getElementById('notification'), notificationMessage = document.getElementById('notificationMessage');
            const registrationForm = document.getElementById('registrationForm'), registrationLog = document.getElementById('registrationLog');
            const regStudentClassSelect = document.getElementById('regStudentClass'), regSubjectSelect = document.getElementById('regSubject');
            const regHocCungLopSelect = document.getElementById('regHocCungLop');
            const thoiGianHocContainer = document.getElementById('thoiGianHocContainer');
            const addSessionBtn = document.getElementById('addSessionBtn');
            const registrationSearchInput = document.getElementById('registrationSearchInput');
            const pendingAbsenceLog = document.getElementById('pendingAbsenceLog');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const leaveForm = document.getElementById('leaveForm'), leaveLog = document.getElementById('leaveLog'), leaveStudentClassSelect = document.getElementById('leaveStudentClass');
            const leaveSearchInput = document.getElementById('leaveSearchInput');
            const importExamBtn = document.getElementById('importExamBtn');
            const examFileUpload = document.getElementById('examFileUpload');
            const examLookupTableBody = document.getElementById('examLookupTableBody');
            const filterClassSelect = document.getElementById('filterClass');
            const filterSubjectSelect = document.getElementById('filterSubject');
            
            let notificationTimeout, confirmCallback = null;

            // --- NAVIGATION ---
            const menuItems = document.querySelectorAll('#sidebar-menu button');
            const contentPages = document.querySelectorAll('.content-page');
            
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetPageId = item.dataset.page;
                    
                    contentPages.forEach(page => page.classList.add('hidden'));
                    document.getElementById(targetPageId).classList.remove('hidden');
                    
                    menuItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    pageTitle.textContent = item.textContent;
                });
            });


            function initializeUI() {
                const headerRow = document.getElementById('summaryTable').querySelector('thead tr');
                classes.forEach(cls => {
                    const th = Object.assign(document.createElement('th'), { textContent: cls });
                    if (cls.startsWith('K75')) th.classList.add('k75-header');
                    headerRow.appendChild(th);
                });
                
                subjects.forEach((sub, index) => {
                    const tr = summaryTableBody.appendChild(document.createElement('tr'));
                    tr.appendChild(Object.assign(document.createElement('td'), { textContent: index + 1, className: 'important-column' }));
                    tr.appendChild(Object.assign(document.createElement('td'), { textContent: sub, className: 'important-column' }));
                    classes.forEach(cls => { 
                        const td = document.createElement('td');
                        td.id = `cell-${sub}-${cls}`;
                        td.textContent = '0';
                        td.dataset.subject = sub;
                        td.dataset.class = cls;
                        if (cls.startsWith('K75')) td.classList.add('k75-cell');
                        tr.appendChild(td); 
                    });
                });

                const allSelects = [studentClassSelect, regStudentClassSelect, regHocCungLopSelect, leaveStudentClassSelect, filterClassSelect];
                filterClassSelect.appendChild(Object.assign(document.createElement('option'), { value: 'all', textContent: 'Tất cả các lớp' }));

                classes.forEach(cls => {
                    allSelects.forEach(sel => sel.appendChild(Object.assign(document.createElement('option'), { value: cls, textContent: cls })));
                });
                
                regHocCungLopSelect.appendChild(Object.assign(document.createElement('option'), { value: "Học riêng", textContent: "Học riêng" }));
                
                const allSubjectSelects = [subjectSelect, regSubjectSelect, filterSubjectSelect];
                filterSubjectSelect.appendChild(Object.assign(document.createElement('option'), { value: 'all', textContent: 'Tất cả các môn' }));

                subjects.forEach(sub => {
                    allSubjectSelects.forEach(sel => sel.appendChild(Object.assign(document.createElement('option'), { value: sub, textContent: sub })));
                });

                document.getElementById('absenceDate').valueAsDate = new Date();
                document.getElementById('leaveStartDate').valueAsDate = new Date();
                addSessionInput(); 
            }

            let loadedFlags = { absence: false, registration: false, exam: false, leave: false };
            function hideLoading() { if (Object.values(loadedFlags).every(Boolean)) { loadingOverlay.style.opacity = '0'; setTimeout(() => loadingOverlay.style.display = 'none', 300); } }
            
            // --- DATA LISTENERS ---
            onSnapshot(query(absenceCollection, orderBy("timestamp", "desc")), (snapshot) => {
                localAbsenceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const today = new Date().toISOString().slice(0, 10);
                const classesWithAbsencesToday = new Set(localAbsenceData.filter(entry => entry.date === today).map(entry => entry.studentClass));
                const pendingAbsences = localAbsenceData.filter(a => a.status === 'pending');
                renderPendingAbsences(pendingAbsences);
                searchInput.dispatchEvent(new Event('input'));
                updateSummaryTable(localAbsenceData, classesWithAbsencesToday);
                loadedFlags.absence = true;
                hideLoading();
            });

            onSnapshot(query(registrationCollection, orderBy("timestamp", "desc")), (snapshot) => { 
                localRegistrationData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                registrationSearchInput.dispatchEvent(new Event('input'));
                loadedFlags.registration = true; 
                hideLoading(); 
            });

            onSnapshot(query(examScheduleCollection), (snapshot) => {
                localExamData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyExamFilters();
                loadedFlags.exam = true;
                hideLoading();
            });
            
            onSnapshot(query(leaveCollection, orderBy("startDate", "desc")), (snapshot) => {
                localLeaveData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                leaveSearchInput.dispatchEvent(new Event('input'));
                loadedFlags.leave = true;
                hideLoading();
            });

            // --- RENDER FUNCTIONS ---
            function updateSummaryTable(data, classesWithAbsencesToday) {
                document.querySelectorAll('#summaryTable tbody td[data-subject]').forEach(cell => {
                    cell.textContent = '0';
                    cell.classList.remove('clickable-cell');
                    cell.style.color = '#a1a1aa';
                });

                const counts = data.reduce((acc, entry) => {
                    if (entry.subject && entry.studentClass) {
                        const subject = entry.subject.trim();
                        const studentClass = entry.studentClass.trim();
                        const cellId = `cell-${subject}-${studentClass}`;
                        acc[cellId] = (acc[cellId] || 0) + 1;
                    }
                    return acc;
                }, {});

                for (const cellId in counts) {
                    const cell = document.getElementById(cellId);
                    if (cell) {
                        const count = counts[cellId];
                        cell.textContent = count;
                        cell.classList.add('clickable-cell');
                        cell.style.color = count <= 2 ? '#f59e0b' : '#dc2626';
                    }
                }
                
                const headerRow = document.getElementById('summaryTable').querySelector('thead tr');
                headerRow.querySelectorAll('th').forEach((th, index) => {
                    if (index < 2) return; 
                    th.classList.remove('today-absence-highlight');
                    if (classesWithAbsencesToday.has(th.textContent)) {
                        th.classList.add('today-absence-highlight');
                    }
                });
            }
            
            function renderPendingAbsences(dataToRender) {
                pendingAbsenceLog.innerHTML = '';
                if (dataToRender.length === 0) {
                    pendingAbsenceLog.innerHTML = `<tr><td colspan="6" class="text-gray-500 py-4 text-center">Không có đơn xin phép nào chờ duyệt.</td></tr>`;
                } else {
                    dataToRender.forEach(entry => {
                        const tr = pendingAbsenceLog.appendChild(document.createElement('tr'));
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `<td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td class="important-column">${entry.subject}</td><td>${new Date(entry.date).toLocaleDateString('vi-VN')}</td><td>${entry.session}</td><td class="space-x-2"><button class="btn btn-approve text-xs px-2 py-1" data-id="${entry.id}"><i class="fas fa-check"></i> Duyệt</button><button class="btn btn-reject text-xs px-2 py-1" data-id="${entry.id}"><i class="fas fa-times"></i> Từ chối</button></td>`;
                    });
                }
            }

            function renderLog(dataToRender) {
                absenceLog.innerHTML = '';
                if (dataToRender.length === 0) {
                    absenceLog.innerHTML = `<tr><td colspan="8" class="text-gray-500 py-4 text-center">Chưa có dữ liệu điểm danh.</td></tr>`;
                } else {
                    dataToRender.forEach(entry => { 
                        const tr = absenceLog.appendChild(document.createElement('tr')); 
                        tr.className = 'hover:bg-gray-50'; 
                        
                        let statusHtml = '';
                        if(entry.permission === 'Có phép') {
                             if (entry.status === 'pending') statusHtml = `<span class="status-badge status-pending">Chờ duyệt</span>`;
                             else if (entry.status === 'approved') statusHtml = `<span class="status-badge status-approved">Đã duyệt</span>`;
                             else if (entry.status === 'rejected') statusHtml = `<span class="status-badge status-rejected">Đã từ chối</span>`;
                        }

                        tr.innerHTML = `<td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td class="important-column">${entry.subject}</td><td>${new Date(entry.date).toLocaleDateString('vi-VN')}</td><td>${entry.session}</td><td class="font-semibold ${entry.permission === 'Có phép' ? 'text-green-600' : 'text-red-600'}">${entry.permission}</td><td>${statusHtml}</td><td><button class="text-red-500 hover:text-red-700 font-medium" data-id="${entry.id}"><i class="fas fa-trash-alt"></i></button></td>`; 
                    });
                }
            }
            
            function renderRegistrationLog(dataToRender) {
                registrationLog.innerHTML = '';
                if (dataToRender.length === 0) {
                    registrationLog.innerHTML = `<tr><td colspan="10" class="text-gray-500 py-4 text-center">Chưa có học viên nào đăng ký.</td></tr>`;
                } else {
                    dataToRender.forEach((entry, index) => {
                        const tr = registrationLog.appendChild(document.createElement('tr'));
                        tr.className = 'hover:bg-gray-50';
                        
                        const thoiGianHocHTML = (entry.thoiGianHoc && Array.isArray(entry.thoiGianHoc)) ? entry.thoiGianHoc.map(t => `${t.ngay ? new Date(t.ngay).toLocaleDateString('vi-VN') : 'N/A'} (${t.buoi || 'N/A'})`).join('<br>') : 'N/A';
                        
                        let statusHtml = '', actionButtons = `<button class="text-red-500 hover:text-red-700 font-medium" data-id="${entry.id}" data-action="delete-reg"><i class="fas fa-trash-alt"></i></button>`;
                        
                        if (entry.status === 'pending') {
                            statusHtml = `<span class="status-badge status-pending">Chờ duyệt</span>`;
                            actionButtons = `<div class="flex gap-2 justify-center"><button class="btn btn-approve text-xs px-2 py-1" data-id="${entry.id}" data-action="approve-reg"><i class="fas fa-check"></i></button><button class="btn btn-reject text-xs px-2 py-1" data-id="${entry.id}" data-action="reject-reg"><i class="fas fa-times"></i></button>${actionButtons}</div>`;
                        } else if (entry.status === 'approved') {
                            statusHtml = `<span class="status-badge status-approved">Đã duyệt</span>`;
                        } else if (entry.status === 'rejected') {
                            statusHtml = `<span class="status-badge status-rejected">Đã từ chối</span>`;
                        }

                        tr.innerHTML = `<td class="important-column">${index + 1}</td><td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td>${entry.chuNhiem}</td><td class="important-column">${entry.subject}</td><td>${entry.chuyenDe || 'N/A'}</td><td class="text-left !whitespace-normal">${thoiGianHocHTML}</td><td>${entry.hocCungLop}</td><td>${statusHtml}</td><td>${actionButtons}</td>`;
                    });
                }
            }

            function renderExamLookupTable(examData) {
                examLookupTableBody.innerHTML = ``;
                if (examData.length === 0) {
                    examLookupTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Chưa có dữ liệu lịch thi.</td></tr>`;
                }
                examData.sort((a,b) => a.Lop.localeCompare(b.Lop) || a.MonHoc.localeCompare(b.MonHoc)).forEach(exam => {
                    const tr = examLookupTableBody.appendChild(document.createElement('tr'));
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `<td class="font-semibold">${exam.Lop}</td><td>${exam.MonHoc}</td><td>${exam.NgayThi ? new Date(exam.NgayThi).toLocaleDateString('vi-VN') : 'N/A'}</td><td>${exam.BuoiThi || 'N/A'}</td><td><button class="text-red-500 hover:text-red-700 font-medium" data-id="${exam.id}"><i class="fas fa-trash-alt"></i></button></td>`;
                });
            }

             function renderLeaveLog(dataToRender) {
                leaveLog.innerHTML = '';
                if (dataToRender.length === 0) {
                    leaveLog.innerHTML = `<tr><td colspan="6" class="text-gray-500 py-4 text-center">Chưa có học viên nào bảo lưu.</td></tr>`;
                } else {
                    dataToRender.forEach((entry, index) => {
                        const tr = leaveLog.appendChild(document.createElement('tr'));
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `<td class="important-column">${index + 1}</td><td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td>${new Date(entry.startDate).toLocaleDateString('vi-VN')}</td><td class="!whitespace-normal text-left">${entry.reason}</td><td><button class="text-red-500 hover:text-red-700 font-medium" data-id="${entry.id}"><i class="fas fa-trash-alt"></i></button></td>`;
                    });
                }
            }
             
            // --- FIRESTORE ACTIONS ---
            async function deleteAbsence(id) { try { await deleteDoc(doc(db, "diem-danh", id)); showNotification("Đã xóa mục điểm danh."); } catch (e) { showNotification('Có lỗi xảy ra, không thể xóa.', true); } }
            async function deleteRegistration(id) { try { await deleteDoc(doc(db, "dang-ky-hoc-bo-sung", id)); showNotification("Đã xóa đăng ký."); } catch (e) { showNotification('Có lỗi xảy ra, không thể xóa.', true); } }
            async function deleteExamSchedule(id) { try { await deleteDoc(doc(db, "lich-thi", id)); showNotification("Đã xóa lịch thi."); } catch (e) { showNotification('Có lỗi xảy ra, không thể xóa.', true); } }
            async function deleteLeaveRequest(id) { try { await deleteDoc(doc(db, "bao-luu-hoc-tap", id)); showNotification("Đã xóa thông tin bảo lưu."); } catch (e) { showNotification('Có lỗi khi xóa.', true);}}

            async function updateAbsenceStatus(id, status, newPermission = null) {
                try {
                    const updateData = { status };
                    if (newPermission) updateData.permission = newPermission;
                    await updateDoc(doc(db, "diem-danh", id), updateData);
                    showNotification("Đã cập nhật trạng thái đơn phép.");
                } catch (e) { showNotification('Có lỗi xảy ra, không thể cập nhật.', true); }
            }
            async function updateRegistrationStatus(id, status) {
                 try {
                    await updateDoc(doc(db, "dang-ky-hoc-bo-sung", id), { status });
                    showNotification("Đã cập nhật trạng thái đăng ký.");
                } catch (e) { showNotification('Có lỗi xảy ra, không thể cập nhật.', true); }
            }
            
            // --- EVENT LISTENERS ---
            absenceForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnHTML = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang xử lý...`;

                const permissionValue = document.getElementById('permission').value;
                const absenceData = { name: document.getElementById('studentName').value, studentClass: studentClassSelect.value, subject: subjectSelect.value, date: document.getElementById('absenceDate').value, session: document.getElementById('session').value, permission: permissionValue, timestamp: serverTimestamp() };
                if (permissionValue === 'Có phép') absenceData.status = 'pending'; else absenceData.status = 'n/a';
                
                try {
                    await addDoc(absenceCollection, absenceData);
                    showNotification('Đã thêm điểm danh thành công!');
                    this.reset();
                    document.getElementById('absenceDate').valueAsDate = new Date();
                    document.getElementById('studentName').focus();

                    submitBtn.innerHTML = `<i class="fas fa-check"></i> Đã thêm!`;
                    setTimeout(() => {
                        submitBtn.innerHTML = originalBtnHTML;
                        submitBtn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error("Error adding absence:", error);
                    showNotification('Có lỗi xảy ra, không thể thêm.', true);
                    submitBtn.innerHTML = originalBtnHTML;
                    submitBtn.disabled = false;
                }
            });
            
            registrationForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnHTML = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang gửi...`;
                
                const chuyenDeValue = document.getElementById('regChuyenDe').value.trim();
                if (!chuyenDeValue) {
                    showNotification('Vui lòng nhập tên chuyên đề.', true);
                    submitBtn.innerHTML = originalBtnHTML;
                    submitBtn.disabled = false;
                    return;
                }
                
                const thoiGianHoc = Array.from(thoiGianHocContainer.querySelectorAll('.session-entry')).map(entry => ({ ngay: entry.querySelector('.regNgayHoc').value, buoi: entry.querySelector('.regBuoiHoc').value })).filter(t => t.ngay && t.buoi);
                if (thoiGianHoc.length === 0) {
                    showNotification('Vui lòng chọn ít nhất một buổi học.', true);
                    submitBtn.innerHTML = originalBtnHTML;
                    submitBtn.disabled = false;
                    return;
                }

                const registrationData = { name: document.getElementById('regStudentName').value, studentClass: document.getElementById('regStudentClass').value, chuNhiem: document.getElementById('regChuNhiem').value, subject: document.getElementById('regSubject').value, chuyenDe: chuyenDeValue, thoiGianHoc, hocCungLop: document.getElementById('regHocCungLop').value, timestamp: serverTimestamp(), status: 'pending' };
                
                try {
                    await addDoc(registrationCollection, registrationData);
                    showNotification('Đăng ký học bổ sung thành công!');
                    this.reset();
                    thoiGianHocContainer.innerHTML = '';
                    addSessionInput();

                    submitBtn.innerHTML = `<i class="fas fa-check"></i> Đã gửi!`;
                    setTimeout(() => {
                        submitBtn.innerHTML = originalBtnHTML;
                        submitBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error("Error adding registration:", error);
                    showNotification('Có lỗi xảy ra, không thể đăng ký.', true);
                    submitBtn.innerHTML = originalBtnHTML;
                    submitBtn.disabled = false;
                }
            });

            leaveForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const leaveData = { name: document.getElementById('leaveStudentName').value, studentClass: document.getElementById('leaveStudentClass').value, startDate: document.getElementById('leaveStartDate').value, reason: document.getElementById('leaveReason').value };
                addDoc(leaveCollection, leaveData)
                    .then(() => {
                        showNotification('Đã lưu thông tin bảo lưu.');
                        this.reset();
                        document.getElementById('leaveStartDate').valueAsDate = new Date();
                    })
                    .catch(e => {
                        console.error("Error adding leave request: ", e);
                        showNotification('Có lỗi khi lưu thông tin.', true);
                    });
            });

            importExamBtn.addEventListener('click', async () => {
                const file = examFileUpload.files[0];
                if (!file) { showNotification('Vui lòng chọn một file Excel.', true); return; }
                loadingOverlay.style.display = 'flex';
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (json[0][0] !== 'Lop' || json[0][1] !== 'MonHoc' || json[0][2] !== 'NgayThi' || json[0][3] !== 'Buoi') throw new Error('Tiêu đề cột không hợp lệ.');
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        const batch = writeBatch(db);
                        jsonData.forEach(record => {
                            if (record.Lop && record.MonHoc && record.NgayThi) {
                                let examDate;
                                if (record.NgayThi instanceof Date) examDate = record.NgayThi;
                                else if (typeof record.NgayThi === 'number') examDate = new Date(Math.round((record.NgayThi - 25569) * 86400 * 1000));
                                else if (typeof record.NgayThi === 'string') {
                                    const parts = record.NgayThi.split(/[/\\-]/);
                                    if (parts.length === 3) examDate = new Date(parts[0].length === 4 ? record.NgayThi : `${parts[2]}-${parts[1]}-${parts[0]}`);
                                }
                                if (!examDate || isNaN(examDate.getTime())) return;
                                
                                const docId = `${record.Lop.toString().trim()}_${record.MonHoc.toString().trim()}`;
                                batch.set(doc(db, "lich-thi", docId), { Lop: record.Lop.toString().trim(), MonHoc: record.MonHoc.toString().trim(), NgayThi: examDate.toISOString().split('T')[0], BuoiThi: (record.Buoi || '').toString().trim() });
                            }
                        });
                        await batch.commit();
                        showNotification(`Đã nhập thành công ${jsonData.length} mục lịch thi.`);
                        examFileUpload.value = '';
                    } catch (error) { showNotification(`Lỗi xử lý file: ${error.message}`, true); } 
                    finally { loadingOverlay.style.display = 'none'; }
                };
                reader.readAsArrayBuffer(file);
            });
            
            examLookupTableBody.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn && btn.dataset.id) showConfirm("Bạn có chắc muốn xóa lịch thi này không?", () => deleteExamSchedule(btn.dataset.id)); });
            
            function applyExamFilters() {
                const selectedClass = filterClassSelect.value;
                const selectedSubject = filterSubjectSelect.value;
                const filteredData = localExamData.filter(exam => (selectedClass === 'all' || (exam.Lop && exam.Lop.trim() === selectedClass)) && (selectedSubject === 'all' || (exam.MonHoc && exam.MonHoc.trim() === selectedSubject)));
                renderExamLookupTable(filteredData);
            }
            [filterClassSelect, filterSubjectSelect].forEach(el => el.addEventListener('change', applyExamFilters));

            function updateSessionButtons() {
                const sessions = thoiGianHocContainer.querySelectorAll('.session-entry');
                sessions.forEach(s => s.querySelector('.remove-session-btn').classList.toggle('hidden', sessions.length <= 1));
                addSessionBtn.disabled = sessions.length >= 4;
                addSessionBtn.classList.toggle('opacity-50', addSessionBtn.disabled);
            }

            function addSessionInput() {
                if (thoiGianHocContainer.children.length >= 4) return;
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'flex items-center gap-2 session-entry';
                sessionDiv.innerHTML = `<input type="date" class="form-input regNgayHoc" required><select class="form-select regBuoiHoc" required><option value="Cả ngày">Cả ngày</option><option value="Sáng">Sáng</option><option value="Chiều">Chiều</option></select><button type="button" class="text-red-500 hover:text-red-700 text-2xl font-bold remove-session-btn">&times;</button>`;
                sessionDiv.querySelector('.regNgayHoc').valueAsDate = new Date();
                sessionDiv.querySelector('.remove-session-btn').addEventListener('click', () => { sessionDiv.remove(); updateSessionButtons(); });
                thoiGianHocContainer.appendChild(sessionDiv);
                updateSessionButtons();
            }

            addSessionBtn.addEventListener('click', addSessionInput);
            absenceLog.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn && btn.dataset.id) showConfirm("Bạn có chắc chắn muốn xóa mục điểm danh này không?", () => deleteAbsence(btn.dataset.id)); });
            
            registrationLog.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || !btn.dataset.id) return;
                const action = btn.dataset.action, id = btn.dataset.id;
                if (action === 'delete-reg') showConfirm("Bạn có chắc chắn muốn xóa đăng ký này không?", () => deleteRegistration(id));
                else if (action === 'approve-reg') updateRegistrationStatus(id, 'approved');
                else if (action === 'reject-reg') updateRegistrationStatus(id, 'rejected');
            });

            pendingAbsenceLog.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || !btn.dataset.id) return;
                if (btn.classList.contains('btn-approve')) updateAbsenceStatus(btn.dataset.id, 'approved');
                else if (btn.classList.contains('btn-reject')) showConfirm("Bạn có chắc chắn từ chối đơn này không? Lý do sẽ được chuyển thành 'Không phép'.", () => updateAbsenceStatus(btn.dataset.id, 'rejected', 'Không phép'));
            });

            leaveLog.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn && btn.dataset.id) showConfirm("Bạn có chắc chắn muốn xóa thông tin bảo lưu này không?", () => deleteLeaveRequest(btn.dataset.id)); });
            searchInput.addEventListener('input', () => renderLog(localAbsenceData.filter(el => Object.values(el).some(val => String(val).toLowerCase().includes(searchInput.value.toLowerCase().trim())))));
            registrationSearchInput.addEventListener('input', () => {
                const searchTerm = registrationSearchInput.value.toLowerCase().trim();
                renderRegistrationLog(localRegistrationData.filter(entry => Object.values(entry).some(val => String(val).toLowerCase().includes(searchTerm))));
            });
             leaveSearchInput.addEventListener('input', () => {
                const searchTerm = leaveSearchInput.value.toLowerCase().trim();
                renderLeaveLog(localLeaveData.filter(entry => Object.values(entry).some(val => String(val).toLowerCase().includes(searchTerm))));
            });

            summaryTableBody.addEventListener('click', (e) => { const cell = e.target.closest('.clickable-cell'); if (cell) showDetailsModal(cell.dataset.subject, cell.dataset.class); });
            
            const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => modal.children[0].classList.add('modal-active'), 10); }
            const closeModalUI = (modal) => { modal.children[0].classList.remove('modal-active'); setTimeout(() => modal.classList.add('hidden'), 300); }
            
            function showDetailsModal(subject, studentClass) {
                if (typeof subject === 'undefined' || typeof studentClass === 'undefined') {
                    console.error("showDetailsModal called with undefined arguments:", subject, studentClass);
                    showNotification("Lỗi: Không thể hiển thị chi tiết.", true);
                    return;
                }

                modalTitle.textContent = `Chi tiết vắng môn ${subject} - Lớp ${studentClass}`;
                
                const absentStudents = localAbsenceData.filter(e => 
                    e.subject && e.studentClass && 
                    e.subject.trim() === subject && e.studentClass.trim() === studentClass
                ).sort((a,b) => a.name.localeCompare(b.name));

                modalBody.innerHTML = '<p class="text-gray-600">Không có dữ liệu vắng.</p>';

                if (absentStudents.length > 0) {
                    modalBody.innerHTML = '<ul class="space-y-3">' + absentStudents.map(student => {
                        const registration = localRegistrationData.find(reg => 
                            reg.name && reg.studentClass && reg.subject && student.name && student.studentClass && student.subject &&
                            reg.name.trim() === student.name.trim() && 
                            reg.studentClass.trim() === student.studentClass.trim() && 
                            reg.subject.trim() === student.subject.trim()
                        );
                        let registrationInfo = '<p class="text-xs text-red-500 font-semibold mt-1"><i class="fas fa-times-circle mr-1"></i>Chưa đăng ký học bổ sung.</p>';
                        if (registration) { 
                            const thoiGianHocHTML = (registration.thoiGianHoc && Array.isArray(registration.thoiGianHoc)) ? registration.thoiGianHoc.map(t => `<li>Ngày ${new Date(t.ngay).toLocaleDateString('vi-VN')} (${t.buoi})</li>`).join('') : '';
                            registrationInfo = `<div class="text-xs text-green-600 font-semibold mt-1"><p><i class="fas fa-check-circle mr-1"></i>Đã ĐK học cùng lớp ${registration.hocCungLop}</p><ul class="list-disc pl-5 mt-1 text-gray-700 font-normal">${thoiGianHocHTML}</ul></div>`; 
                        }
                        let statusText = '';
                        if (student.status === 'pending') statusText = ` <span class="status-badge status-pending">Chờ duyệt</span>`;
                        else if (student.status === 'approved') statusText = ` <span class="status-badge status-approved">Đã duyệt</span>`;
                        else if (student.status === 'rejected') statusText = ` <span class="status-badge status-rejected">Đã từ chối</span>`;
                        return `<li class="p-3 rounded-md bg-gray-100 border border-gray-200"><strong class="text-gray-800">${student.name}</strong> - Ngày: ${new Date(student.date).toLocaleDateString('vi-VN')} (${student.session}) - <span class="${student.permission === 'Có phép' ? 'text-green-600' : 'text-red-600'} font-semibold">${student.permission}</span>${statusText}${registrationInfo}</li>`;
                    }).join('') + '</ul>';
                }
                openModal(detailsModal);
            }
            function showNotification(message, isError = false) { clearTimeout(notificationTimeout); notificationMessage.textContent = message; notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 z-[70] ${isError ? 'bg-red-600' : 'bg-green-600'}`; notification.classList.remove('hidden', 'opacity-0'); notificationTimeout = setTimeout(() => notification.classList.add('opacity-0'), 3000); }
            function showConfirm(message, callback) { confirmMessage.textContent = message; confirmCallback = callback; openModal(confirmModal); }
            
            closeModal.addEventListener('click', () => closeModalUI(detailsModal));
            detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeModalUI(detailsModal); });
            confirmCancel.addEventListener('click', () => closeModalUI(confirmModal));
            confirmOk.addEventListener('click', () => { closeModalUI(confirmModal); if (confirmCallback) confirmCallback(); });
            
            exportExcelBtn.addEventListener('click', () => {
                const dataToExport = localRegistrationData.map((entry, index) => {
                    let thoiGianHocText = (entry.thoiGianHoc && Array.isArray(entry.thoiGianHoc)) ? entry.thoiGianHoc.map(t => `${t.ngay ? new Date(t.ngay).toLocaleDateString('vi-VN') : 'N/A'} (${t.buoi || 'N/A'})`).join('; ') : 'N/A';
                    let statusText = {'pending': 'Chờ duyệt', 'approved': 'Đã duyệt', 'rejected': 'Đã từ chối'}[entry.status] || entry.status || '';
                    return { 'STT': index + 1, 'Họ tên HV': entry.name, 'Tên lớp': entry.studentClass, 'Chủ nhiệm': entry.chuNhiem, 'Môn học': entry.subject, 'Chuyên đề': entry.chuyenDe, 'Thời gian học': thoiGianHocText, 'Học cùng lớp': entry.hocCungLop, 'Trạng thái': statusText };
                });
                if (dataToExport.length === 0) { showNotification('Không có dữ liệu để xuất.', true); return; }
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DanhSachDangKy');
                XLSX.writeFile(workbook, 'DanhSachDangKyHocBoSung.xlsx');
                showNotification('Đã xuất file Excel thành công!');
            });

            initializeUI();
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeAppLogic();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed", error);
                    showAuthError();
                });
            }
        });
    </script>
</body>
</html>

