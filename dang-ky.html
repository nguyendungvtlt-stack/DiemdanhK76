<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký & Điểm Danh - HVCTKV II</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #334155; /* Slate-700 */
            --primary-dark-color: #1e293b; /* Slate-800 */
            --secondary-color: #0d9488; /* Teal-600 */
            --secondary-dark-color: #0f766e; /* Teal-700 */
            --summary-header-bg: #881337; /* Rose-900, for a formal look */
            --pending-color: #f59e0b; /* Amber-500 */
            --approved-color: #16a34a; /* Green-600 */
            --rejected-color: #dc2626; /* Red-600 */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('Background.jfif');
            background-color: #f3f0e9;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-card { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); border: 1px solid #e2e8f0; }
        .table-container { max-width: 100%; overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; max-height: 50vh; overflow-y: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e2e8f0; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.875rem; white-space: nowrap; }
        th { color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-select, .form-input { border-radius: 0.5rem; border: 1px solid #cbd5e1; padding: 0.6rem 0.8rem; width: 100%; background-color: #f8fafc; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(51, 65, 85, 0.4); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.5rem; padding: 0.625rem 1.25rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background-color: var(--primary-dark-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-secondary { background-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover { background-color: var(--secondary-dark-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        #loadingOverlay { transition: opacity 0.3s; }
        .multiselect-dropdown { position: relative; display: inline-block; width: 100%; }
        .multiselect-dropdown-content { display: none; position: absolute; background-color: #fff; width: 100%; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); padding: 0.5rem; z-index: 10; max-height: 200px; overflow-y: auto; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .clickable-cell { cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .clickable-cell:hover { background-color: #f1f5f9; }
        .important-column { color: #111827; font-weight: 500; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .modal-scale { transform: translate(0, -25%) scale(0.95); opacity: 0; }
        .modal-active { transform: translate(0, 0) scale(1); opacity: 1; }
        .today-absence-highlight {
            background-color: #facc15 !important; /* Yellow-400 */
            color: #1e293b !important; /* Slate-800 for better text contrast */
        }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; color: white; }
        .status-pending { background-color: var(--pending-color); }
        .status-approved { background-color: var(--approved-color); }
        .status-rejected { background-color: var(--rejected-color); }
        /* --- STICKY TABLE HEADERS & COLUMNS --- */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #summaryTable > thead > tr > th {
            background-color: var(--summary-header-bg);
            color: white;
        }
        #summaryTable th:nth-child(1), #summaryTable td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 1;
        }
        #summaryTable th:nth-child(2), #summaryTable td:nth-child(2) {
            position: sticky;
            left: 67px; /* width + padding + border */
            z-index: 1;
        }
        #summaryTable td:nth-child(1),
        #summaryTable td:nth-child(2) {
            background-color: #f1f5f9;
        }
        #summaryTable th:nth-child(1),
        #summaryTable th:nth-child(2) {
            z-index: 11;
        }
         #summaryTable td:nth-child(2) {
            border-right: 2px solid #9ca3af;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
             <div class="w-16 h-16 border-4 border-slate-700 border-t-transparent rounded-full animate-spin"></div>
             <p class="mt-4 text-gray-700 font-semibold">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="max-w-screen-2xl mx-auto">
        <!-- Main Content Column -->
        <div class="space-y-8">
            <header class="content-card p-4 md:p-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <img src="CODANG, CO TO QUOC.gif" alt="Cờ Đảng, Cờ Tổ Quốc" class="h-20 hidden sm:block">
                    <div class="flex items-center gap-4 ml-auto">
                        <div class="text-center md:text-right">
                            <h1 class="text-xl md:text-3xl font-extrabold text-red-900 uppercase">Học viện Chính trị khu vực II</h1>
                            <p class="text-sm md:text-base text-gray-800 font-semibold">Ban Quản lý đào tạo, bồi dưỡng</p>
                            <p class="text-xs md:text-sm text-gray-600 font-medium">Bộ phận quản lý học viên</p>
                        </div>
                        <img src="LOGO HV2.png" alt="Logo Học viện Chính trị khu vực II" class="h-20 w-20 md:h-24 md:w-24 object-contain flex-shrink-0">
                    </div>
                </div>
            </header>

            <main class="space-y-6">
                
                <h2 class="text-2xl font-bold text-gray-800">Phần mềm quản lý<span class="text-slate-700"> điểm danh & đăng ký học bổ sung</span></h2>

                <!-- Bảng thống kê -->
                <section class="content-card">
                     <div class="card-header"><h3 class="text-xl font-bold text-slate-700">Bảng thống kê điểm danh</h3></div>
                     <div class="p-4"><div class="table-container"><table id="summaryTable"><thead><tr><th>STT</th><th>Tên môn học</th></tr></thead><tbody></tbody></table></div></div>
                </section>
                
                <!-- Lịch sử điểm danh -->
                <section class="content-card">
                    <div class="card-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h3 class="text-xl font-bold text-slate-700">Lịch sử điểm danh (Chỉ xem)</h3>
                        <input type="text" id="searchInput" placeholder="Tìm kiếm trong lịch sử..." class="form-input w-full sm:w-64">
                    </div>
                    <div class="p-4"><div class="table-container"><table class="w-full"><thead style="background-color: var(--summary-header-bg);"><tr><th>Họ và tên</th><th>Lớp</th><th>Môn học</th><th>Ngày vắng</th><th>Buổi</th><th>Lý do</th><th>Trạng thái</th></tr></thead><tbody id="absenceLog" class="bg-white"></tbody></table></div></div>
                </section>

                <!-- Tra Cứu Lịch Thi -->
                <section class="content-card">
                    <div class="card-header"><h3 class="text-xl font-bold text-indigo-800">Tra cứu Lịch thi</h3></div>
                    <div class="p-6 space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo lớp</label>
                                <select id="filterClass" class="form-select"></select>
                            </div>
                            <div class="flex-1">
                                <label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo môn</label>
                                <select id="filterSubject" class="form-select"></select>
                            </div>
                        </div>
                        <div class="table-container max-h-80">
                           <table class="w-full">
                               <thead class="bg-stone-700"><tr><th>Lớp</th><th>Môn học</th><th>Ngày thi</th><th>Buổi</th></tr></thead>
                               <tbody id="examLookupTableBody" class="bg-white"></tbody>
                           </table>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Form Điểm danh -->
                    <section class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-slate-700">CNL/Cán bộ Ban QLĐTBD nhập thông tin điểm danh</h3></div>
                        <form id="absenceForm" class="p-6 space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label><input type="text" id="studentName" class="form-input" placeholder="Nguyễn Văn A" required></div>
                                <div><label for="studentClass" class="block text-sm font-medium text-gray-700 mb-1">Tên lớp</label><select id="studentClass" class="form-select" required></select></div>
                                <div><label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Tên môn học</label><select id="subject" class="form-select" required></select></div>
                                <div><label for="absenceDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày vắng</label><input type="date" id="absenceDate" class="form-input" required></div>
                                <div><label for="session" class="block text-sm font-medium text-gray-700 mb-1">Buổi</label><select id="session" class="form-select" required><option value="Sáng">Sáng</option><option value="Chiều">Chiều</option></select></div>
                                <div><label for="permission" class="block text-sm font-medium text-gray-700 mb-1">Lý do</label><select id="permission" class="form-select" required><option value="Không phép">Không phép</option><option value="Có phép">Có phép</option></select></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full sm:w-auto"><i class="fa-solid fa-plus"></i>Thêm lượt vắng</button>
                        </form>
                    </section>
                    
                    <!-- Form Đăng ký -->
                    <section class="content-card">
                        <div class="card-header"><h3 class="text-xl font-bold text-teal-600">Học viên đăng ký học bổ sung</h3></div>
                        <form id="registrationForm" class="p-6 space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="regStudentName" class="block text-sm font-medium text-gray-700 mb-1">Họ tên của bạn</label><input type="text" id="regStudentName" class="form-input" placeholder="Nguyễn Văn A" required></div>
                                <div><label for="regStudentClass" class="block text-sm font-medium text-gray-700 mb-1">Lớp của bạn</label><select id="regStudentClass" class="form-select" required></select></div>
                                <div class="sm:col-span-2"><label for="regChuNhiem" class="block text-sm font-medium text-gray-700 mb-1">Chủ nhiệm lớp</label><input type="text" id="regChuNhiem" class="form-input" placeholder="Trần Thị B" required></div>
                                <div><label for="regSubject" class="block text-sm font-medium text-gray-700 mb-1">Môn học cần bổ sung</label><select id="regSubject" class="form-select" required></select></div>
                                <div class="multiselect-dropdown"><label class="block text-sm font-medium text-gray-700 mb-1">Chọn chuyên đề</label><button type="button" id="regChuyenDeBtn" class="form-input text-left w-full">Chọn chuyên đề...</button><div id="regChuyenDeDropdown" class="multiselect-dropdown-content"></div></div>
                                
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thời gian học (Tối đa 4 buổi)</label>
                                    <div id="thoiGianHocContainer" class="space-y-2">
                                        <!-- Session inputs will be dynamically added here by JS -->
                                    </div>
                                    <button type="button" id="addSessionBtn" class="mt-2 text-sm btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-3 py-1"><i class="fa-solid fa-plus mr-1"></i>Thêm buổi</button>
                                </div>

                                <div class="sm:col-span-2"><label for="regHocCungLop" class="block text-sm font-medium text-gray-700 mb-1">Đăng ký học cùng lớp</label><select id="regHocCungLop" class="form-select" required></select></div>
                            </div>
                            <button type="submit" class="btn btn-secondary w-full sm:w-auto"><i class="fa-solid fa-check"></i>Gửi đăng ký</button>
                        </form>
                    </section>
                </div>

                <section class="content-card">
                    <div class="card-header"><h3 class="text-xl font-bold text-teal-600">Danh sách đã đăng ký (Chỉ xem)</h3></div>
                    <div class="p-4"><div class="table-container"><table class="w-full"><thead style="background-color: var(--summary-header-bg);"><tr><th>STT</th><th>Họ tên HV</th><th>Lớp</th><th>Chủ nhiệm</th><th>Môn học</th><th>Chuyên đề</th><th>Thời gian học</th><th>Học cùng lớp</th></tr></thead><tbody id="registrationLog" class="bg-white"></tbody></table></div></div>
                </section>
            </main>
            
            <footer class="text-center text-sm text-gray-500 py-4 bg-white/70 backdrop-blur-sm rounded-lg">
                <p>&copy; 2024 Học viện Chính trị khu vực II.</p>
                <p>Phát triển bởi: Dungcdr - Email: nguyendungvtlt@gmail.com</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition-opacity duration-300"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transition-all duration-300 modal-scale"><div class="p-4 border-b flex justify-between items-center"><h3 id="modalTitle" class="text-lg font-bold text-gray-800">Chi tiết điểm danh</h3><button id="closeModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div><div id="modalBody" class="p-6 max-h-[60vh] overflow-y-auto"></div></div></div>
    <div id="notification" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transition-all duration-300 z-50"><p id="notificationMessage"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyAdwypOgoxMcrA2JxsfKD2vUqbnLfUuqzA", authDomain: "diem-danh-hoc-vien.firebaseapp.com", projectId: "diem-danh-hoc-vien", storageBucket: "diem-danh-hoc-vien.firebasestorage.app", messagingSenderId: "186541306115", appId: "1:186541306115:web:89424d662913ec9f9a3936", measurementId: "G-2T5MQRG9JQ" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const registrationCollection = collection(db, 'dang-ky-hoc-bo-sung');
        const absenceCollection = collection(db, 'diem-danh');
        const examScheduleCollection = collection(db, 'lich-thi');

        document.addEventListener('DOMContentLoaded', function () {
            const subjects = ["Tuần lễ học viên", "TRIET", "KTCT", "CNXH", "TTHCM", "LSĐ", "QLKT", "NNPL", "KTPT", "QHQT", "VHPT", "GDQP", "TGTN", "LLDT", "GIOI", "QCN", "KHLĐ", "XHH", "CTH", "XDĐ", "NgK"];
            const classes = Array.from({ length: 12 }, (_, i) => `K76.A${(i + 1).toString().padStart(2, '0')}`);
            const tempChuyenDe = Array.from({ length: 19 }, (_, i) => `CĐ${i + 1}`);
            const chuyenDeOptions = [...tempChuyenDe, "Chuyên đề thảo luận"];
            let localAbsenceData = [], localRegistrationData = [], localExamData = [];
            
            const summaryTableBody = document.getElementById('summaryTable').querySelector('tbody');
            const absenceForm = document.getElementById('absenceForm'), absenceLog = document.getElementById('absenceLog');
            const studentClassSelect = document.getElementById('studentClass'), subjectSelect = document.getElementById('subject');
            const searchInput = document.getElementById('searchInput');

            const registrationForm = document.getElementById('registrationForm'), registrationLog = document.getElementById('registrationLog');
            const regStudentClassSelect = document.getElementById('regStudentClass'), regSubjectSelect = document.getElementById('regSubject');
            const regChuyenDeBtn = document.getElementById('regChuyenDeBtn'), regChuyenDeDropdown = document.getElementById('regChuyenDeDropdown');
            const regHocCungLopSelect = document.getElementById('regHocCungLop');
            const thoiGianHocContainer = document.getElementById('thoiGianHocContainer');
            const addSessionBtn = document.getElementById('addSessionBtn');

            const detailsModal = document.getElementById('detailsModal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), closeModal = document.getElementById('closeModal');
            const notification = document.getElementById('notification'), notificationMessage = document.getElementById('notificationMessage');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            const examLookupTableBody = document.getElementById('examLookupTableBody');
            const filterClassSelect = document.getElementById('filterClass');
            const filterSubjectSelect = document.getElementById('filterSubject');


            let notificationTimeout;

            function initializeUI() {
                const headerRow = document.getElementById('summaryTable').querySelector('thead tr');
                classes.forEach(cls => headerRow.appendChild(Object.assign(document.createElement('th'), { textContent: cls })));
                
                subjects.forEach((sub, index) => {
                    const tr = summaryTableBody.appendChild(document.createElement('tr'));
                    tr.appendChild(Object.assign(document.createElement('td'), { textContent: index + 1, className: 'important-column' }));
                    tr.appendChild(Object.assign(document.createElement('td'), { textContent: sub, className: 'important-column' }));
                    classes.forEach(cls => { const td = Object.assign(document.createElement('td'), { id: `cell-${sub}-${cls}`, textContent: '0' }); td.dataset.subject = sub; td.dataset.class = cls; tr.appendChild(td); });
                });

                classes.forEach(cls => {
                    studentClassSelect.appendChild(Object.assign(document.createElement('option'), { value: cls, textContent: cls }));
                    regStudentClassSelect.appendChild(Object.assign(document.createElement('option'), { value: cls, textContent: cls }));
                    regHocCungLopSelect.appendChild(Object.assign(document.createElement('option'), { value: cls, textContent: cls }));
                });

                filterClassSelect.appendChild(Object.assign(document.createElement('option'), { value: 'all', textContent: 'Tất cả các lớp' }));
                classes.forEach(cls => {
                    filterClassSelect.appendChild(Object.assign(document.createElement('option'), { value: cls, textContent: cls }));
                });

                filterSubjectSelect.appendChild(Object.assign(document.createElement('option'), { value: 'all', textContent: 'Tất cả các môn' }));
                subjects.forEach(sub => {
                    filterSubjectSelect.appendChild(Object.assign(document.createElement('option'), { value: sub, textContent: sub }));
                });

                regHocCungLopSelect.appendChild(Object.assign(document.createElement('option'), { value: "Học riêng", textContent: "Học riêng" }));
                
                subjects.forEach(sub => {
                    subjectSelect.appendChild(Object.assign(document.createElement('option'), { value: sub, textContent: sub }));
                    regSubjectSelect.appendChild(Object.assign(document.createElement('option'), { value: sub, textContent: sub }));
                });

                chuyenDeOptions.forEach(cd => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 p-1 hover:bg-gray-100 rounded-md';
                    label.innerHTML = `<input type="checkbox" class="form-checkbox rounded text-teal-600 focus:ring-teal-600" value="${cd}"><span>${cd}</span>`;
                    regChuyenDeDropdown.appendChild(label);
                });

                document.getElementById('absenceDate').valueAsDate = new Date();
                addSessionInput(); // Add the first session on load
            }
            
            let loadedFlags = { absence: false, registration: false, exam: false };
            function hideLoading() { if (Object.values(loadedFlags).every(Boolean)) { loadingOverlay.style.opacity = '0'; setTimeout(() => loadingOverlay.style.display = 'none', 300); } }

            onSnapshot(query(absenceCollection, orderBy("timestamp", "desc")), (snapshot) => {
                localAbsenceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const today = new Date();
                const todayString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                const classesWithAbsencesToday = new Set(localAbsenceData.filter(entry => entry.date === todayString).map(entry => entry.studentClass));
                renderAbsenceLog(localAbsenceData);
                updateSummaryTable(localAbsenceData, classesWithAbsencesToday);
                loadedFlags.absence = true;
                hideLoading();
            });

            onSnapshot(query(registrationCollection, orderBy("timestamp", "desc")), (snapshot) => { localRegistrationData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderRegistrationLog(localRegistrationData); loadedFlags.registration = true; hideLoading(); });

             onSnapshot(query(examScheduleCollection), (snapshot) => {
                localExamData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyExamFilters();
                loadedFlags.exam = true;
                hideLoading();
            });
            
            function updateSummaryTable(data, classesWithAbsencesToday) {
                const relevantAbsences = data.filter(entry => entry.permission === 'Không phép' || entry.status === 'approved');
                const counts = relevantAbsences.reduce((acc, entry) => { acc[`cell-${entry.subject}-${entry.studentClass}`] = (acc[`cell-${entry.subject}-${entry.studentClass}`] || 0) + 1; return acc; }, {});
                document.querySelectorAll('#summaryTable tbody td[data-subject]').forEach(cell => { const count = counts[cell.id] || 0; cell.textContent = count; cell.classList.toggle('clickable-cell', count > 0); cell.style.color = count === 0 ? '#a1a1aa' : (count <= 2 ? '#f59e0b' : '#dc2626'); });
            
                const headerRow = document.getElementById('summaryTable').querySelector('thead tr');
                const headers = headerRow.querySelectorAll('th');

                headers.forEach((th, index) => {
                    if (index < 2) return;
                    th.classList.remove('today-absence-highlight');
                    if (classesWithAbsencesToday.has(th.textContent)) {
                        th.classList.add('today-absence-highlight');
                    }
                });
            }

            function renderAbsenceLog(dataToRender) {
                absenceLog.innerHTML = '';
                if (dataToRender.length === 0) { const tr = absenceLog.appendChild(document.createElement('tr')); const td = tr.appendChild(document.createElement('td')); td.colSpan = 7; td.textContent = "Chưa có dữ liệu điểm danh."; td.className = 'text-gray-500 py-4 text-center'; } else {
                    dataToRender.forEach((entry) => {
                        const tr = absenceLog.appendChild(document.createElement('tr'));
                        tr.className = 'hover:bg-gray-50';

                        let statusHtml = '';
                        if (entry.status === 'pending') {
                            statusHtml = `<span class="status-badge status-pending">Chờ duyệt</span>`;
                        } else if (entry.status === 'approved') {
                            statusHtml = `<span class="status-badge status-approved">Đã duyệt</span>`;
                        } else if (entry.status === 'rejected') {
                            statusHtml = `<span class="status-badge status-rejected">Đã từ chối</span>`;
                        }

                        tr.innerHTML = `<td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td class="important-column">${entry.subject}</td><td>${new Date(entry.date).toLocaleDateString('vi-VN')}</td><td>${entry.session}</td><td class="font-semibold ${entry.permission === 'Có phép' ? 'text-green-600' : 'text-red-600'}">${entry.permission}</td><td>${statusHtml}</td>`;
                    });
                }
            }

            function renderRegistrationLog(dataToRender) {
                registrationLog.innerHTML = '';
                if (dataToRender.length === 0) { const tr = registrationLog.appendChild(document.createElement('tr')); const td = tr.appendChild(document.createElement('td')); td.colSpan = 8; td.textContent = "Chưa có học viên nào đăng ký."; td.className = 'text-gray-500 py-4 text-center'; } else {
                    dataToRender.forEach((entry, index) => {
                        const tr = registrationLog.appendChild(document.createElement('tr'));
                        tr.className = 'hover:bg-gray-50';
                        
                        let thoiGianHocHTML = 'N/A';
                        if (entry.thoiGianHoc && Array.isArray(entry.thoiGianHoc)) {
                            thoiGianHocHTML = entry.thoiGianHoc.map(t => {
                                const ngayHoc = t.ngay ? new Date(t.ngay).toLocaleDateString('vi-VN') : 'N/A';
                                return `${ngayHoc} (${t.buoi || 'N/A'})`;
                            }).join('<br>');
                        }
                        
                        const chuyenDeList = Array.isArray(entry.chuyenDe) ? entry.chuyenDe.join(', ') : (entry.chuyenDe || 'N/A');
                        tr.innerHTML = `<td class="important-column">${index + 1}</td><td class="important-column">${entry.name}</td><td>${entry.studentClass}</td><td>${entry.chuNhiem}</td><td class="important-column">${entry.subject}</td><td>${chuyenDeList}</td><td class="text-left !whitespace-normal">${thoiGianHocHTML}</td><td>${entry.hocCungLop}</td>`;
                    });
                }
            }

             function renderExamLookupTable(examData) {
                examLookupTableBody.innerHTML = '';
                if (examData.length === 0) {
                    examLookupTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">Chưa có dữ liệu lịch thi.</td></tr>`;
                    return;
                }
                examData.sort((a,b) => a.Lop.localeCompare(b.Lop) || a.MonHoc.localeCompare(b.MonHoc)).forEach(exam => {
                    const tr = examLookupTableBody.appendChild(document.createElement('tr'));
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="font-semibold">${exam.Lop}</td>
                        <td>${exam.MonHoc}</td>
                        <td>${exam.NgayThi ? new Date(exam.NgayThi).toLocaleDateString('vi-VN') : 'N/A'}</td>
                        <td>${exam.BuoiThi || 'N/A'}</td>
                    `;
                });
            }
            
            async function addAbsence(entry) { 
                try { 
                    await addDoc(absenceCollection, entry); 
                    showNotification('Đã thêm điểm danh thành công! Trạng thái đang chờ duyệt.'); 
                } catch (e) { 
                    console.error("Error adding absence: ", e); 
                    showNotification('Có lỗi xảy ra khi điểm danh.', true); 
                } 
            }

            absenceForm.addEventListener('submit', function(e) { 
                e.preventDefault(); 
                const permissionValue = document.getElementById('permission').value;
                const absenceData = { 
                    name: document.getElementById('studentName').value, 
                    studentClass: document.getElementById('studentClass').value, 
                    subject: document.getElementById('subject').value, 
                    date: document.getElementById('absenceDate').value, 
                    session: document.getElementById('session').value, 
                    permission: permissionValue, 
                    timestamp: serverTimestamp() 
                };

                if (permissionValue === 'Có phép') {
                    absenceData.status = 'pending';
                } else {
                    absenceData.status = 'n/a';
                }

                addAbsence(absenceData);
                this.reset();
                document.getElementById('absenceDate').valueAsDate = new Date(); 
            });

            registrationForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedChuyenDe = Array.from(regChuyenDeDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                if (selectedChuyenDe.length === 0) { showNotification('Vui lòng chọn ít nhất một chuyên đề.', true); return; }
                
                const thoiGianHoc = [];
                const sessionEntries = thoiGianHocContainer.querySelectorAll('.session-entry');
                sessionEntries.forEach(entry => {
                    const ngay = entry.querySelector('.regNgayHoc').value;
                    const buoi = entry.querySelector('.regBuoiHoc').value;
                    if (ngay && buoi) thoiGianHoc.push({ ngay, buoi });
                });
                if (thoiGianHoc.length === 0) { showNotification('Vui lòng chọn ít nhất một buổi học.', true); return; }

                const formData = { 
                    name: document.getElementById('regStudentName').value, 
                    studentClass: document.getElementById('regStudentClass').value, 
                    chuNhiem: document.getElementById('regChuNhiem').value, 
                    subject: document.getElementById('regSubject').value, 
                    chuyenDe: selectedChuyenDe, 
                    thoiGianHoc, 
                    hocCungLop: document.getElementById('regHocCungLop').value, 
                    timestamp: serverTimestamp() 
                };
                try { 
                    await addDoc(registrationCollection, formData); 
                    showNotification('Đăng ký học bổ sung thành công!'); 
                    this.reset(); 
                    thoiGianHocContainer.innerHTML = '';
                    addSessionInput();
                    regChuyenDeBtn.textContent = 'Chọn chuyên đề...'; 
                    regChuyenDeDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); 
                } catch (err) { 
                    console.error("Error adding registration: ", err); 
                    showNotification('Có lỗi xảy ra, không thể đăng ký.', true); 
                }
            });

             function applyExamFilters() {
                const selectedClass = filterClassSelect.value;
                const selectedSubject = filterSubjectSelect.value;

                const filteredData = localExamData.filter(exam => {
                    const classMatch = (selectedClass === 'all') || (exam.Lop && exam.Lop.trim() === selectedClass);
                    const subjectMatch = (selectedSubject === 'all') || (exam.MonHoc && exam.MonHoc.trim() === selectedSubject);
                    return classMatch && subjectMatch;
                });

                renderExamLookupTable(filteredData);
            }

            filterClassSelect.addEventListener('change', applyExamFilters);
            filterSubjectSelect.addEventListener('change', applyExamFilters);

            function updateSessionButtons() {
                const sessions = thoiGianHocContainer.querySelectorAll('.session-entry');
                sessions.forEach((session) => {
                    const removeBtn = session.querySelector('.remove-session-btn');
                    removeBtn.classList.toggle('hidden', sessions.length <= 1);
                });
                addSessionBtn.disabled = sessions.length >= 4;
                addSessionBtn.classList.toggle('opacity-50', addSessionBtn.disabled);
                addSessionBtn.classList.toggle('cursor-not-allowed', addSessionBtn.disabled);
            }

            function addSessionInput() {
                if (thoiGianHocContainer.children.length >= 4) return;
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'flex items-center gap-2 session-entry';
                sessionDiv.innerHTML = `
                    <input type="date" class="form-input regNgayHoc" required>
                    <select class="form-select regBuoiHoc" required>
                        <option value="Cả ngày">Cả ngày</option>
                        <option value="Sáng">Sáng</option>
                        <option value="Chiều">Chiều</option>
                    </select>
                    <button type="button" class="text-red-500 hover:text-red-700 text-2xl font-bold remove-session-btn">&times;</button>
                `;
                sessionDiv.querySelector('.regNgayHoc').valueAsDate = new Date();
                sessionDiv.querySelector('.remove-session-btn').addEventListener('click', () => {
                    sessionDiv.remove();
                    updateSessionButtons();
                });
                thoiGianHocContainer.appendChild(sessionDiv);
                updateSessionButtons();
            }

            addSessionBtn.addEventListener('click', addSessionInput);
            
            searchInput.addEventListener('input', () => { const term = searchInput.value.toLowerCase().trim(); const filtered = localAbsenceData.filter(e => Object.values(e).some(val => String(val).toLowerCase().includes(term))); renderAbsenceLog(filtered); });
            summaryTableBody.addEventListener('click', (e) => { const cell = e.target.closest('.clickable-cell'); if (cell) showDetailsModal(cell.dataset.subject, cell.dataset.class); });

            const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.add('modal-active'); }, 10); }
            const closeModalUI = (modal) => { modal.children[0].classList.remove('modal-active'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); }

            function showDetailsModal(subject, studentClass) {
                const absentStudents = localAbsenceData.filter(e => e.subject === subject && e.studentClass === studentClass).sort((a,b) => a.name.localeCompare(b.name));
                modalTitle.textContent = `Chi tiết vắng môn ${subject} - Lớp ${studentClass}`;
                let modalContent = '<p class="text-gray-600">Không có dữ liệu vắng.</p>';
                if (absentStudents.length > 0) {
                    modalContent = '<ul class="space-y-3">';
                    absentStudents.forEach(student => {
                        const registration = localRegistrationData.find(reg => reg.name === student.name && reg.studentClass === student.studentClass && reg.subject === student.subject);
                        let registrationInfo = '<p class="text-xs text-red-500 font-semibold mt-1"><i class="fas fa-times-circle mr-1"></i>Chưa đăng ký học bổ sung.</p>';
                        if (registration) { 
                            let thoiGianHocHTML = '';
                            if (registration.thoiGianHoc && Array.isArray(registration.thoiGianHoc)) {
                                 thoiGianHocHTML = registration.thoiGianHoc.map(t => `<li>Ngày ${new Date(t.ngay).toLocaleDateString('vi-VN')} (${t.buoi})</li>`).join('');
                            }
                            registrationInfo = `
                                <div class="text-xs text-green-600 font-semibold mt-1">
                                    <p><i class="fas fa-check-circle mr-1"></i>Đã ĐK học cùng lớp ${registration.hocCungLop}</p>
                                    <ul class="list-disc pl-5 mt-1 text-gray-700 font-normal">${thoiGianHocHTML}</ul>
                                </div>`; 
                        }
                        
                        let statusText = '';
                        if (student.status === 'pending') statusText = ` <span class="status-badge status-pending">Chờ duyệt</span>`;
                        else if (student.status === 'approved') statusText = ` <span class="status-badge status-approved">Đã duyệt</span>`;
                        else if (student.status === 'rejected') statusText = ` <span class="status-badge status-rejected">Đã từ chối</span>`;

                        modalContent += `<li class="p-3 rounded-md bg-gray-100 border border-gray-200"><strong class="text-gray-800">${student.name}</strong> - Ngày: ${new Date(student.date).toLocaleDateString('vi-VN')} (${student.session}) - <span class="${student.permission === 'Có phép' ? 'text-green-600' : 'text-red-600'} font-semibold">${student.permission}</span>${statusText}${registrationInfo}</li>`;
                    });
                    modalContent += '</ul>';
                }
                modalBody.innerHTML = modalContent;
                openModal(detailsModal);
            }

            function showNotification(message, isError = false) { clearTimeout(notificationTimeout); notificationMessage.textContent = message; notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`; notification.classList.remove('hidden', 'opacity-0'); notificationTimeout = setTimeout(() => notification.classList.add('opacity-0'), 3000); }
            
            closeModal.addEventListener('click', () => closeModalUI(detailsModal));
            detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeModalUI(detailsModal); });
            
            regChuyenDeBtn.addEventListener('click', () => { regChuyenDeDropdown.style.display = regChuyenDeDropdown.style.display === 'block' ? 'none' : 'block'; });
            regChuyenDeDropdown.addEventListener('change', () => { const selected = Array.from(regChuyenDeDropdown.querySelectorAll('input:checked')).map(cb => cb.value); regChuyenDeBtn.textContent = selected.length > 0 ? selected.join(', ') : 'Chọn chuyên đề...'; });
            document.addEventListener('click', (e) => { if (!regChuyenDeBtn.contains(e.target) && !regChuyenDeDropdown.contains(e.target)) { regChuyenDeDropdown.style.display = 'none'; } });

            initializeUI();
        });
    </script>
</body>
</html>

